\section{How to deploy the whole system}

\subsection{Create a swarm}

Before deploying the whole system, please make sure your machine meets the
requirements listed in Section \ref{req}.
After that, you will be ready to create your first local swarm.

The project will be deployed on a single machine. However, due to its intrinsic
distributed nature, the system is more suited to be deployed on more hosts in
a real use case.

We'll use Docker Swarm to easily deploy and manage the system, which can be
viewed as composition of different isolated components.
To create a local swarm, type the following command:

\begin{lstlisting}[language=bash]
docker swarm init --advertise-addr <YOUR_LOCAL_IP_ADDRESS>
\end{lstlisting}

Substitute the \texttt{<YOUR\_LOCAL\_IP\_ADDRESS>} parameter with your local
IP address.

You can check the IP assigned to your machine by the local router with:

\begin{lstlisting}[language=bash]
ip addr show| grep -A1 <NETWORK_INTERFACE>
\end{lstlisting}

Note the parameter between \texttt{<NETWORK\_INTERFACE>} must
be replaced by the network interface associated with the IP currently in use
(e.g., wlan0).



\subsection{Create a registry}

After the swarm has been successfully created, we need to instantiate a local
registry to store the project images. Do not worry if this registry looks like
as an always-running container, it is the standard case for it.
Before creating and running the registry, we have to verify that port 5000
on our host is not already in use by another process.

You can check the port status on your host with the following command:

\begin{lstlisting}[language=bash]
sudo netstat -tulpn | grep LISTEN | grep 5000
\end{lstlisting}

If you do not have netstat on your system, another feasible command is the
following:

\begin{lstlisting}[language=bash]
sudo lsof -i -P -n | grep LISTEN | grep 5000
\end{lstlisting}

If the result is empty (no entry returned) then port 5000 is free.

We can create our registry:

\begin{lstlisting}[language=bash]
docker service create --detach=false --name registry --publish 5000:5000 registry:latest
\end{lstlisting}

If you encounter any problem during these steps, then
consult the FAQ and troubleshooting sections, where you will find (hopefully)
helpful information.

\subsection{Build}

To build the system as a whole type the following commands from the root
directory of the project (i.e., acts):

\begin{lstlisting}[language=bash]
./build.sh -s backend-mw-fe -m p
\end{lstlisting}

\noindent\textbf{IMPORTANT} \textit{Before starting your system, set the value
of the \texttt{CITY\_ROOT} environment variable to the path of the ACTS project
directory. For example, if you placed the repository in the folder
\texttt{home/goofy/acts}, set the \texttt{CITY\_ROOT} environment variable to
\texttt{home/goofy/acts}, without appending the last slash (\texttt{/})
character}.

This instruction builds the three macro components together in production mode.
You can view each step of the build process by looking at the stdout of the CLI
(that is, the command line interface):

\begin{enumerate}
\item Generation for the configuration files for the city (e.g., district
  configs, routing tables, etc.);
\item Check for district configurations soundness. Actually \texttt{ACTS}
  checks if each city graph is a strongly connected component to guarantee
  valid preconditions for the AI. Thus, each agent safely knows she will
  find its path between two arbitrary locations of a city;
\item Build of the images which makes up the system. Note that this step
  takes, in general, some time to complete;
\item Copy of the necessary files in their target directories.
\end{enumerate}

\subsection{Run}

After the build process has successfully completed, you are finally able to
run the whole system.

To deploy the whole system type the following command from the root directory
of the project (i.e., acts):

\begin{lstlisting}[language=bash]
./run.sh -s backend-mw-fe
\end{lstlisting}

Which deploys the whole system using Docker Swarm.
If no problem is encountered during the deployment, the whole system is now up
and running.
You can now access the user control panel (viewer) by means of a browser at the
following address:

\begin{lstlisting}[language=bash]
0.0.0.0:4005
\end{lstlisting}
